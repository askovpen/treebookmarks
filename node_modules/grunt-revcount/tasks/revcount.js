'use strict';

module.exports = function(grunt) {
  grunt.registerTask('revcount', 'Retrieves the current git revisions count', function(property) {
    var options = this.options({
      property: 'meta.revision',
      ref: 'HEAD'
    });

    var done = this.async();

    grunt.util.spawn({
      cmd: 'git',
      args: ['rev-list', options.ref,'--count'].filter(Boolean)
    }, function(err, result) {
      if (err) {
        grunt.log.error(err);

        return done(false);
      }

      var revision = result.toString();

      grunt.config(options.property, revision);
      grunt.log.writeln(options.ref + ' at revisions count ' + revision);

      done(true);
    });
  });
};
